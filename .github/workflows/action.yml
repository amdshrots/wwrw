name: macOS Remote Desktop

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup-remote-desktop:
    runs-on: macOS-latest
    timeout-minutes: 360  # Set the job to run for 6 hours

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"

      - name: Enable SSH and Configure X11 Forwarding
        run: |
          # Enable Remote Login for SSH
          sudo systemsetup -setremotelogin on

          # Stop and restart SSH to ensure it's properly loaded
          sudo launchctl unload -w /System/Library/LaunchDaemons/ssh.plist || true
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist

          # Configure SSH for X11 Forwarding
          echo "X11Forwarding yes" | sudo tee -a /etc/ssh/sshd_config
          echo "X11UseLocalhost yes" | sudo tee -a /etc/ssh/sshd_config

          # Restart SSH service to apply configuration
          sudo launchctl stop com.openssh.sshd || true
          sudo launchctl start com.openssh.sshd

          # Print IP address and SSH details
          echo "IP Address: $(curl -s ifconfig.me)"
          echo "Connect using SSH with the username 'runner'."
          echo "Example: ssh -Y runner@<ip-address>"

      - name: Keep the Runner Active
        run: |
          # Keep the runner active by running a no-op command in a loop
          while true; do
            sleep 3600  # Sleep for 1 hour
          done
        shell: bash
