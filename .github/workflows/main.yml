name: macOS VNC Tunnel (Production-Ready)
on:
  workflow_dispatch:

env:
  VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
  VNC_PASS: ${{ secrets.VNC_PASSWORD }}  # Must be set!
  PINGGY_TOKEN: ${{ secrets.PINGGY_TOKEN }}

jobs:
  setup-macos-vnc:
    runs-on: macos-13
    
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "$VNC_PASS" ] || [ -z "$PINGGY_TOKEN" ]; then
            echo "::error::Missing required secrets: VNC_PASSWORD and/or PINGGY_TOKEN"
            exit 1
          fi

      - name: Create Secure Remote User
        run: |
          # Generate random UID to avoid conflicts
          UID=$(shuf -i 2000-3000 -n 1)
          sudo sysadminctl -addUser "$VNC_USER" -password "$VNC_PASS" -uid $UID -admin
          sudo pmset -a displaysleep 0 sleep 0

      - name: Enable VNC with Error Handling
        run: |
          if ! sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent; then
            echo "::warning::kickstart failed (may be deprecated), attempting alternative..."
            sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          fi

      - name: Grant TCC Permissions (Adaptive)
        run: |
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          
          # Detect schema version
          COL_COUNT=$(sudo sqlite3 "$TCC_DB" "PRAGMA table_info(access);" | wc -l | tr -d ' ')
          echo "Detected TCC.db schema with $COL_COUNT columns"
          
          # Build VALUES clause with correct column count
          VALUES="('kTCCServiceScreenCapture','com.apple.screensharing.agent',0,1,1"
          for i in $(seq 1 $(($COL_COUNT - 5))); do
            VALUES="$VALUES,NULL"
          done
          VALUES="$VALUES)"
          
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES$VALUES;"
          
          # Restart service
          sudo launchctl kickstart -k system/com.apple.screensharing

      - name: Start Pinggy Tunnel
        run: |
          curl -L https://pinggy.io/pinggy-cli -o /tmp/pinggy
          chmod +x /tmp/pinggy
          
          # Run in background and capture output
          /tmp/pinggy -p 5900 -t tcp -k "$PINGGY_TOKEN" > /tmp/pinggy-url.txt 2>&1 &
          sleep 10
          
          URL=$(grep -o 'tcp://[^:]*:[0-9]*' /tmp/pinggy-url.txt || echo "Check Pinggy dashboard")
          echo "::notice::VNC URL: $URL"

      - name: Display Connection Info
        run: |
          echo "=========================================="
          echo "âœ… macOS VNC is ready!"
          echo ""
          echo "VNC Address: See Pinggy URL above or https://a.pinggy.io/"
          echo "Username: $VNC_USER"
          echo "Password: [REDACTED]"
          echo "=========================================="

      - name: Keep Alive (Efficient)
        run: sleep 21600  # 6 hours

      - name: Cleanup
        if: always()
        run: |
          echo "Removing temporary user..."
          sudo sysadminctl -deleteUser "$VNC_USER" -keepHome 2>/dev/null || true
          sudo pkill -f pinggy || true
          
