name: macOS VNC Tunnel (Production-Ready)
on:
  workflow_dispatch:

env:
  VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
  VNC_PASS: ${{ secrets.VNC_PASSWORD }}
  PINGGY_TOKEN: ${{ secrets.PINGGY_TOKEN }}

jobs:
  setup-macos-vnc:
    runs-on: macos-13
    
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "$VNC_PASS" ] || [ -z "$PINGGY_TOKEN" ]; then
            echo "::error::Missing VNC_PASSWORD or PINGGY_TOKEN secrets!"
            exit 1
          fi

      - name: Create Remote User
        env:
          VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
          VNC_PASS: ${{ secrets.VNC_PASSWORD }}
        run: |
          sudo sysadminctl -addUser "$VNC_USER" -password "$VNC_PASS" -admin
          sudo pmset -a displaysleep 0 sleep 0

      - name: Enable VNC
        env:
          VNC_PASS: ${{ secrets.VNC_PASSWORD }}
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" -restart -agent || true

      - name: Grant TCC Permissions
        run: |
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          COL_COUNT=$(sudo sqlite3 "$TCC_DB" "PRAGMA table_info(access);" | wc -l | tr -d ' ')
          BASE_VALUES="'kTCCServiceScreenCapture','com.apple.screensharing.agent',0,1,1,1"
          NULLS=$(printf ',NULL%.0s' $(seq 1 $((COL_COUNT - 6))))
          
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES($BASE_VALUES$NULLS);"
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.screensharing.agent',$BASE_VALUES$NULLS);"
          sudo launchctl kickstart -k system/com.apple.screensharing

      - name: Start Pinggy CLI
        env:
          PINGGY_TOKEN: ${{ secrets.PINGGY_TOKEN }}
        run: |
          curl -L https://pinggy.io/pinggy-cli -o /tmp/pinggy
          chmod +x /tmp/pinggy
          # Use token from secrets
          /tmp/pinggy -p 5900 -t tcp "$PINGGY_TOKEN+tcp@eu.free.pinggy.io" > /tmp/pinggy-url.txt 2>&1 &
          sleep 10

      - name: Display Connection Info
        env:
          VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
        run: |
          URL=$(grep -o 'tcp://[^:]*:[0-9]*' /tmp/pinggy-url.txt || echo "Check Pinggy dashboard")
          echo "=========================================="
          echo "âœ… VNC Ready!"
          echo "Address: $URL"
          echo "User: $VNC_USER"
          echo "Password: [REDACTED]"
          echo "=========================================="

      - name: Keep Alive (6h)
        run: sleep 21600

      - name: Cleanup
        if: always()
        env:
          VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
        run: |
          sudo sysadminctl -deleteUser "$VNC_USER" 2>/dev/null || true
          sudo pkill -f pinggy || true
          
