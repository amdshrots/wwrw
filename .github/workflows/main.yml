name: macOS VNC Tunnel (Hardcoded Credentials)
on:
  workflow_dispatch:

env:
  # HARDCODED - WILL BE VISIBLE IN LOGS
  VNC_USER: runneradmin
  VNC_PASS: p@ssw0rd!
  # HARDCODED TOKEN - COMPROMISED
  PINGGY_TOKEN: gtcxZbEfnfR+tcp@eu.free.pinggy.io

jobs:
  setup-macos-vnc:
    runs-on: macos-13
    
    steps:
      - name: Create Remote User (Credentials Visible)
        run: |
          echo "Creating user: $VNC_USER with password: $VNC_PASS"
          sudo sysadminctl -addUser "$VNC_USER" -password "$VNC_PASS" -admin
          sudo pmset -a displaysleep 0 sleep 0

      - name: Enable VNC
        run: |
          echo "Setting VNC password: $VNC_PASS"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent || echo "kickstart completed with warnings"

      - name: Grant TCC Permissions
        run: |
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          COL_COUNT=$(sudo sqlite3 "$TCC_DB" "PRAGMA table_info(access);" | wc -l | tr -d ' ')
          NULL_COUNT=$((COL_COUNT - 6))
          NULLS=$(printf ',NULL%.0s' $(seq 1 $NULL_COUNT))
          
          SCREEN_CAPTURE="'kTCCServiceScreenCapture','com.apple.screensharing.agent',0,1,1,1$NULLS"
          ACCESSIBILITY="'kTCCServiceAccessibility','com.apple.screensharing.agent',0,1,1,1$NULLS"
          
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES($SCREEN_CAPTURE);"
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES($ACCESSIBILITY);"
          sudo launchctl kickstart -k system/com.apple.screensharing

      - name: Install and Start Pinggy (Fixed Binary)
        run: |
          echo "Downloading Pinggy CLI..."
          # CORRECT BINARY FOR macOS INTEL
          curl -L https://a.pinggy.io/pinggy_darwin_amd64 -o /tmp/pinggy
          chmod +x /tmp/pinggy
          
          echo "Starting tunnel with token: $PINGGY_TOKEN"
          /tmp/pinggy -p 5900 -t tcp "$PINGGY_TOKEN" > /tmp/pinggy-url.txt 2>&1 &
          sleep 10
          
          echo "---RAW PINGGY OUTPUT---"
          cat /tmp/pinggy-url.txt
          echo "---END OUTPUT---"
          
          # Extract tunnel URL
          URL=$(grep -o 'tcp://[^ ]*' /tmp/pinggy-url.txt | head -1)
          echo "=========================================="
          echo "ðŸŒ TUNNEL ADDRESS: $URL"
          echo "=========================================="

      - name: Display Connection Details
        run: |
          echo "=========================================="
          echo "âœ… VNC SERVER READY!"
          echo ""
          echo "ðŸ” CREDENTIALS (HARDCODED):"
          echo "Username: $VNC_USER"
          echo "Password: $VNC_PASS"
          echo ""
          echo "ðŸŒ CONNECTION INFO:"
          echo "Tunnel Address: See above step"
          echo "VNC Port: 5900"
          echo ""
          echo "â±ï¸ Runner expires in 6 hours"
          echo "=========================================="

      - name: Keep Alive (6h)
        run: sleep 21600

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up user: $VNC_USER"
          sudo sysadminctl -deleteUser "$VNC_USER" 2>/dev/null || true
          sudo pkill -f pinggy || true
          
