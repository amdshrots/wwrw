name: macOS RDP Tunnel (Final Version)
on:
  workflow_dispatch:

jobs:
  setup-macos-rdp:
    runs-on: macos-13 # Using macos-13 (Ventura) for stability

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Create a New User for Remote Access
        run: |
          # Create a new user with a known password and grant admin privileges.
          # This is the most reliable way to ensure you can log in.
          # The user will be named 'github-user' with the password 'p@ssw0rd!'
          sudo sysadminctl -addUser github-user -password p@ssw0rd! -admin

          # Prevent the Mac from sleeping
          sudo pmset -a displaysleep 0 sleep 0

      - name: Enable and Configure Remote Management (VNC)
        run: |
          # This command enables Screen Sharing and grants all necessary privileges.
          # It will apply to all users, including our new 'github-user'.
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw p@ssw0rd! \
            -restart -agent

      - name: Fix Black Screen by Granting Screen Recording Permissions
        run: |
          # This command grants the necessary permissions to prevent the black screen.
          # It is updated for modern macOS versions.
          sudo /usr/bin/sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.screensharing.agent',0,1,1,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,NULL,NULL,NULL);"
          sudo /usr/bin/sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR REPLACE INTO access VALUES('kTCCServiceAccessibility','com.apple.screensharing.agent',0,1,1,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,NULL,NULL,NULL);"

          # Restart the screen sharing service to ensure the new permissions are loaded
          sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist

      - name: Download and Set Up Pinggy for Tunneling
        run: |
          # Download Pinggy CLI tool
          curl -L https://pinggy.io/pinggy-cli -o /tmp/pinggy
          chmod +x /tmp/pinggy

      - name: Start Pinggy Tunnel and Display Connection Info
        run: |
          # Start Pinggy in the background to tunnel port 5900 (VNC)
          /tmp/pinggy -p 5900 -t tcp -k ${{ secrets.PINGGY_TOKEN }} &
          PINGGY_PID=$!
          echo "Pinggy started with PID: $PINGGY_PID"

          # Wait a moment for the tunnel to initialize
          sleep 15

          # Display connection instructions clearly in the log
          echo "=========================================="
          echo "macOS Remote Desktop is ready!"
          echo ""
          echo "To get your connection URL, go to:"
          echo "https://a.pinggy.io/"
          echo ""
          echo "VNC Address: Use the URL from the Pinggy dashboard"
          echo "VNC Port: 5900"
          echo "Username: github-user"
          echo "Password: p@ssw0rd!"
          echo "=========================================="

      - name: Keep the GitHub Action Runner Alive
        run: |
          # This loop keeps the workflow running for up to 6 hours
          echo "Workflow will stay active for 6 hours."
          for i in {1..21600}; do
            sleep 1
          done
