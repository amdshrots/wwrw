name: macOS Playit.gg + VNC

on:
  workflow_dispatch:

jobs:
  playit-vnc:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install and Start VNC Server
        run: |
          brew install tigervnc
          mkdir -p ~/.vnc
          echo "password" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          /usr/local/bin/vncserver :1 -geometry 1280x800 -depth 24

      - name: Install Rust
        run: |
          if ! command -v cargo >/dev/null; then
            curl https://sh.rustup.rs -sSf | sh -s -- -y
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          fi

      - name: Clone Playit Agent and Build
        working-directory: playit-agent
        run: |
          git clone https://github.com/playit-cloud/playit-agent.git
          cargo build --release

      - name: Run Playit agent with secret
        working-directory: playit-agent
        env:
          PLAYIT_SECRET: ${{ secrets.PL }}
        run: |
          ./target/release/playit-cli --secret "$PLAYIT_SECRET"
