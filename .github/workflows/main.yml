name: macOS VNC Tunnel (Direct Token)
on:
  workflow_dispatch:

env:
  VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
  VNC_PASS: ${{ secrets.VNC_PASSWORD }}
  # Hardcoded token - will be visible in logs
  PINGGY_TOKEN: gtcxZbEfnfR+tcp@eu.free.pinggy.io

jobs:
  setup-macos-vnc:
    runs-on: macos-13
    
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "$VNC_PASS" ]; then
            echo "::error::Missing VNC_PASSWORD secret!"
            exit 1
          fi

      - name: Create Remote User
        env:
          VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
          VNC_PASS: ${{ secrets.VNC_PASSWORD }}
        run: |
          sudo sysadminctl -addUser "$VNC_USER" -password "$VNC_PASS" -admin
          sudo pmset -a displaysleep 0 sleep 0

      - name: Enable VNC
        env:
          VNC_PASS: ${{ secrets.VNC_PASSWORD }}
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" -restart -agent || true

      - name: Grant TCC Permissions
        run: |
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          COL_COUNT=$(sudo sqlite3 "$TCC_DB" "PRAGMA table_info(access);" | wc -l | tr -d ' ')
          NULL_COUNT=$((COL_COUNT - 6))
          NULLS=$(printf ',NULL%.0s' $(seq 1 $NULL_COUNT))
          
          SCREEN_CAPTURE="'kTCCServiceScreenCapture','com.apple.screensharing.agent',0,1,1,1$NULLS"
          ACCESSIBILITY="'kTCCServiceAccessibility','com.apple.screensharing.agent',0,1,1,1$NULLS"
          
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES($SCREEN_CAPTURE);"
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access VALUES($ACCESSIBILITY);"
          sudo launchctl kickstart -k system/com.apple.screensharing

      - name: Install and Start Pinggy (Token Visible)
        env:
          PINGGY_TOKEN: gtcxZbEfnfR+tcp@eu.free.pinggy.io
        run: |
          curl -L https://pinggy.io/pinggy-cli -o /tmp/pinggy
          chmod +x /tmp/pinggy
          
          echo "Starting Pinggy tunnel..."
          /tmp/pinggy -p 5900 -t tcp "$PINGGY_TOKEN" > /tmp/pinggy-url.txt 2>&1 &
          sleep 10
          
          # Display raw output for debugging
          echo "---Raw Pinggy Output---"
          cat /tmp/pinggy-url.txt
          echo "---End Output---"
          
          # Extract and show URL
          URL=$(grep -E 'tcp://[^ ]+' /tmp/pinggy-url.txt | head -1 || echo "URL extraction failed")
          echo "=========================================="
          echo "ðŸŒ TUNNEL ADDRESS: $URL"
          echo "=========================================="
          echo "::notice::VNC Tunnel: $URL"

      - name: Display Connection Info
        env:
          VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
        run: |
          echo "=========================================="
          echo "âœ… VNC Ready!"
          echo "Username: $VNC_USER"
          echo "Password: [REDACTED]"
          echo ""
          echo "CHECK PREVIOUS STEP FOR TUNNEL ADDRESS!"
          echo "=========================================="

      - name: Keep Alive (6h)
        run: sleep 21600

      - name: Cleanup
        if: always()
        env:
          VNC_USER: ${{ secrets.VNC_USERNAME || 'github-remote' }}
        run: |
          sudo sysadminctl -deleteUser "$VNC_USER" 2>/dev/null || true
          sudo pkill -f pinggy || true
          
